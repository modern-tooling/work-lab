#!/bin/bash
# work-lab combined right status for tmux
# Outputs: git · dc · time (with proper separators, hiding empty segments)
# Colors are handled by tmux format strings

# Colors (for reference, actual coloring in tmux.conf)
# sky_blue=#64a0dc (git)
# gold=#ffd23c (dc)
# dim=#8c969f (time, separators)
# sep=#3a3f4a (separator color)

segments=()

# Git status
cd /workspaces/project 2>/dev/null
branch=$(git symbolic-ref --short HEAD 2>/dev/null || git rev-parse --short HEAD 2>/dev/null)
if [[ -n "$branch" ]]; then
  [[ ${#branch} -gt 20 ]] && branch="${branch:0:17}..."
  if git diff --quiet 2>/dev/null && git diff --cached --quiet 2>/dev/null; then
    segments+=("#[fg=#64a0dc]$branch#[default]")
  else
    segments+=("#[fg=#64a0dc]$branch*#[default]")
  fi
fi

# DC status - shows paired devcontainer state
# ⚡dc (gold)   = connected and reachable
# ⚠dc (amber)  = devcontainer exists but not connected
# (nothing)    = no devcontainer in project
has_devcontainer=false
dc_connected=false

# check if project has a devcontainer config
if [[ -d /workspaces/project/.devcontainer ]] || \
   [[ -f /workspaces/project/.devcontainer.json ]]; then
  has_devcontainer=true
fi

# check SSH tunnel connectivity (docker not available in work-lab)
if [[ -f /workspaces/project/.work-lab/ip ]]; then
  dc_ip=$(cat /workspaces/project/.work-lab/ip 2>/dev/null)
  dc_port=$(cat /workspaces/project/.work-lab/port 2>/dev/null || echo "2222")
  if [[ -n "$dc_ip" ]]; then
    # try configured port, then fallback to 2222 and 22
    if nc -z -w 1 "$dc_ip" "$dc_port" 2>/dev/null || \
       nc -z -w 1 "$dc_ip" 2222 2>/dev/null || \
       nc -z -w 1 "$dc_ip" 22 2>/dev/null; then
      dc_connected=true
    fi
  fi
fi

if $dc_connected; then
  segments+=("#[fg=#ffd23c]⚡dc#[default]")
elif $has_devcontainer; then
  segments+=("#[fg=#e5a050]⚠ dc#[default]")
fi

# Time (always shown)
segments+=("#[fg=#8c969f]$(date +%H:%M)#[default]")

# Join with dim separators
sep="#[fg=#3a3f4a] · #[default]"
result=""
for i in "${!segments[@]}"; do
  [[ $i -gt 0 ]] && result+="$sep"
  result+="${segments[$i]}"
done

echo "$result "
