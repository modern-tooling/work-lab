#!/bin/bash
# work-lab devcontainer status for tmux status bar
# Shows "⚡ dc" if paired devcontainer is running, nothing otherwise
# Keeping the status bar clean when dc not available

# Quick check: is docker available?
command -v docker &>/dev/null || exit 0

# Get project name from the mounted workspace
project_name=$(basename /workspaces/project 2>/dev/null) || exit 0

# Look for a devcontainer matching this project (excluding work-lab containers)
while IFS= read -r container_id; do
  [[ -z "$container_id" ]] && continue

  container_name=$(docker inspect --format '{{.Name}}' "$container_id" 2>/dev/null | tr -d '/')
  [[ "$container_name" == *"work-lab"* ]] && continue

  local_folder=$(docker inspect --format '{{index .Config.Labels "devcontainer.local_folder"}}' "$container_id" 2>/dev/null)
  folder_name=$(basename "$local_folder" 2>/dev/null)

  if [[ "$folder_name" == "$project_name" ]]; then
    echo "⚡ dc"
    exit 0
  fi
done < <(docker ps --filter "label=devcontainer.local_folder" --format '{{.ID}}' 2>/dev/null)
