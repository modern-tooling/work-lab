#!/usr/bin/env bash
# work-lab
# Copyright (c) 2026 Ryan Snodgrass. MIT License.
# A small convenience script for managing the work-lab devcontainer.
# This script is OPTIONAL. You can use the devcontainer CLI or VS Code directly.

set -Eeuo pipefail

VERSION="0.1.0"

# shellcheck disable=SC2155
readonly SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd -P)"
# shellcheck disable=SC2155
readonly REPO_DIR="$(dirname -- "$SCRIPT_DIR")"

# error handler for debugging
trap 'printf "Error at line %d: exit %d\n" "$LINENO" "$?" >&2' ERR

# ─────────────────────────────────────────────────────────────────────────────
# Configuration
# ─────────────────────────────────────────────────────────────────────────────
# Defaults (can be overridden by ~/.config/work-lab/config or environment)
: "${WORK_LAB_PROJECTS_DIR:=$HOME/projects}"
: "${WORK_LAB_IMAGE:=ghcr.io/modern-tooling/work-lab:latest}"

# Additional mounts (arrays, set in config file)
# Format: "source:target" - will be mounted read-only or read-write
WORK_LAB_MOUNTS_RO=()    # read-only mounts
WORK_LAB_MOUNTS_RW=()    # read-write mounts

# Source user config if present (can override defaults above)
config_file="$HOME/.config/work-lab/config"
if [[ -f "$config_file" ]]; then
  # shellcheck source=/dev/null
  source "$config_file"
fi

# Export for devcontainer.json ${localEnv:...} substitution
export WORK_LAB_PROJECTS_DIR
export WORK_LAB_IMAGE

# Build mount flags for devcontainer up
build_mount_flags() {
  local flags=()
  local mount_spec source target

  # Add read-only mounts
  for mount_spec in "${WORK_LAB_MOUNTS_RO[@]}"; do
    source="${mount_spec%%:*}"
    target="${mount_spec#*:}"
    # Expand ~ and $HOME
    source="${source/#\~/$HOME}"
    source="${source//\$HOME/$HOME}"
    if [[ -e "$source" ]]; then
      flags+=("--mount" "type=bind,source=$source,target=$target,readonly")
    else
      echo "  [warn] skipping mount (source not found): $source" >&2
    fi
  done

  # Add read-write mounts
  for mount_spec in "${WORK_LAB_MOUNTS_RW[@]}"; do
    source="${mount_spec%%:*}"
    target="${mount_spec#*:}"
    # Expand ~ and $HOME
    source="${source/#\~/$HOME}"
    source="${source//\$HOME/$HOME}"
    if [[ -e "$source" ]]; then
      flags+=("--mount" "type=bind,source=$source,target=$target")
    else
      echo "  [warn] skipping mount (source not found): $source" >&2
    fi
  done

  printf '%s\n' "${flags[@]}"
}

usage() {
  cat << EOF
work-lab - manage the work-lab devcontainer

Usage:
  work-lab up       Start the devcontainer
  work-lab shell    Attach an interactive shell
  work-lab tmux     Attach to tmux session (creates 'lab' if missing)
  work-lab stop     Stop the container
  work-lab doctor   Check environment and configuration
  work-lab version  Show version information
  work-lab help     Show this message

This script is optional. You can also:
  - Open the folder in VS Code and use "Reopen in Container"
  - Use the devcontainer CLI directly
EOF
}

cmd_version() {
  echo "work-lab $VERSION"
}

# Find the running container ID
find_container() {
  docker ps -q --filter "label=devcontainer.local_folder=$REPO_DIR" 2>/dev/null | head -n 1
}

cmd_up() {
  if ! command -v devcontainer &> /dev/null; then
    echo "devcontainer CLI not found."
    echo "Install it with: npm install -g @devcontainers/cli"
    echo "Or open this folder in VS Code and use 'Reopen in Container'."
    exit 1
  fi

  echo "Starting devcontainer..."

  # Build additional mount flags from config
  local mount_flags=()
  if [[ ${#WORK_LAB_MOUNTS_RO[@]} -gt 0 ]] || [[ ${#WORK_LAB_MOUNTS_RW[@]} -gt 0 ]]; then
    echo "Additional mounts:"
    readarray -t mount_flags < <(build_mount_flags)
  fi

  # Run devcontainer up with any additional mounts
  devcontainer up --workspace-folder "$REPO_DIR" "${mount_flags[@]}"
}

cmd_shell() {
  local container_id
  container_id=$(find_container)
  if [[ -z "$container_id" ]]; then
    echo "Container not running. Start it with: work-lab up" >&2
    exit 1
  fi
  docker exec -it -u vscode -w /workspaces/work-lab "$container_id" bash
}

cmd_tmux() {
  local container_id
  container_id=$(find_container)
  if [[ -z "$container_id" ]]; then
    echo "Container not running. Start it with: work-lab up" >&2
    exit 1
  fi
  # Attach to existing session or create a new one named 'lab'
  docker exec -it -u vscode -w /workspaces/work-lab "$container_id" \
    bash -c 'tmux attach -t lab 2>/dev/null || tmux new -s lab'
}

cmd_stop() {
  local container_id
  container_id=$(find_container)
  if [[ -z "$container_id" ]]; then
    echo "Container not running."
    exit 0
  fi
  echo "Stopping container..."
  docker stop "$container_id"
  echo "Stopped."
}

cmd_doctor() {
  local container_id config_dir project_count

  echo ""
  echo "work-lab doctor"
  echo "==============="
  echo ""

  # check work-lab repo
  echo "work-lab repo:"
  if [[ -d "$REPO_DIR/.devcontainer" ]]; then
    echo "  [ok] $REPO_DIR"
  else
    echo "  [error] not found at $REPO_DIR"
  fi
  echo ""

  # check dependencies
  echo "Dependencies:"
  if command -v docker &>/dev/null; then
    echo "  [ok] docker: $(docker --version | head -n 1)"
  else
    echo "  [error] docker: not found"
  fi
  if command -v devcontainer &>/dev/null; then
    echo "  [ok] devcontainer CLI: $(devcontainer --version 2>/dev/null || echo 'installed')"
  else
    echo "  [warn] devcontainer CLI: not found (install with: npm install -g @devcontainers/cli)"
  fi
  echo ""

  # check container status
  echo "Container:"
  container_id=$(find_container)
  if [[ -n "$container_id" ]]; then
    echo "  [ok] running (id: ${container_id:0:12})"
  else
    echo "  [info] not running"
  fi
  echo ""

  # show configuration
  echo "Configuration:"
  config_dir="$HOME/.config/work-lab"
  if [[ -f "$config_dir/config" ]]; then
    echo "  [ok] config file: $config_dir/config"
  else
    echo "  [info] config file: not found (using defaults)"
  fi
  echo "  WORK_LAB_PROJECTS_DIR=$WORK_LAB_PROJECTS_DIR"
  echo "  WORK_LAB_IMAGE=$WORK_LAB_IMAGE"
  if [[ ${#WORK_LAB_MOUNTS_RO[@]} -gt 0 ]]; then
    echo "  WORK_LAB_MOUNTS_RO: ${#WORK_LAB_MOUNTS_RO[@]} configured"
    for m in "${WORK_LAB_MOUNTS_RO[@]}"; do
      echo "    - $m (ro)"
    done
  fi
  if [[ ${#WORK_LAB_MOUNTS_RW[@]} -gt 0 ]]; then
    echo "  WORK_LAB_MOUNTS_RW: ${#WORK_LAB_MOUNTS_RW[@]} configured"
    for m in "${WORK_LAB_MOUNTS_RW[@]}"; do
      echo "    - $m (rw)"
    done
  fi
  echo ""

  # check user hooks
  echo "User hooks (~/.config/work-lab/):"
  if [[ -d "$config_dir" ]]; then
    if [[ -f "$config_dir/post-create.sh" ]]; then
      echo "  [ok] post-create.sh"
    else
      echo "  [info] post-create.sh (not found)"
    fi
    if [[ -f "$config_dir/post-start.sh" ]]; then
      echo "  [ok] post-start.sh"
    else
      echo "  [info] post-start.sh (not found)"
    fi
  else
    echo "  [info] directory not found (optional)"
  fi
  echo ""

  # check projects mount source
  echo "Projects directory:"
  if [[ -d "$WORK_LAB_PROJECTS_DIR" ]]; then
    project_count=$(find "$WORK_LAB_PROJECTS_DIR" -maxdepth 1 -type d 2>/dev/null | wc -l | tr -d ' ')
    echo "  [ok] $WORK_LAB_PROJECTS_DIR ($((project_count - 1)) items)"
  else
    echo "  [warn] $WORK_LAB_PROJECTS_DIR not found"
    echo "         create it or set WORK_LAB_PROJECTS_DIR in config"
  fi
  echo ""

  # check if current directory has a devcontainer
  echo "Current directory ($PWD):"
  if [[ -d ".devcontainer" ]] || [[ -f ".devcontainer.json" ]]; then
    if [[ "$PWD" == "$REPO_DIR" ]]; then
      echo "  [info] this is the work-lab repo"
    else
      echo "  [info] has devcontainer -> Sidecar mode"
    fi
  else
    echo "  [info] no devcontainer -> Standalone mode"
  fi
  echo ""
}

# Main
case "${1:-}" in
  up)
    cmd_up
    ;;
  shell)
    cmd_shell
    ;;
  tmux)
    cmd_tmux
    ;;
  stop)
    cmd_stop
    ;;
  doctor)
    cmd_doctor
    ;;
  version|--version|-v)
    cmd_version
    ;;
  help|--help|-h)
    usage
    ;;
  "")
    usage
    exit 1
    ;;
  *)
    echo "Unknown command: $1"
    usage
    exit 1
    ;;
esac
