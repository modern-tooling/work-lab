#!/usr/bin/env bash
# work-lab
# Copyright (c) 2026 Ryan Snodgrass. MIT License.
# A small convenience script for managing the work-lab devcontainer.
# This script is OPTIONAL. You can use the devcontainer CLI or VS Code directly.

set -Eeuo pipefail

VERSION="0.1.0"

# shellcheck disable=SC2155
readonly SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd -P)"
# shellcheck disable=SC2155
readonly REPO_DIR="$(dirname -- "$SCRIPT_DIR")"

# error handler for debugging
trap 'printf "Error at line %d: exit %d\n" "$LINENO" "$?" >&2' ERR

# ─────────────────────────────────────────────────────────────────────────────
# Configuration
# ─────────────────────────────────────────────────────────────────────────────
# Defaults (can be overridden by ~/.config/work-lab/config or environment)
: "${WORK_LAB_IMAGE:=ghcr.io/modern-tooling/work-lab:latest}"

# Additional mounts (arrays, set in config file)
# Format: "source:target" - will be mounted read-only or read-write
WORK_LAB_MOUNTS_RO=()    # read-only mounts
WORK_LAB_MOUNTS_RW=()    # read-write mounts

# Source user config if present (can override defaults above)
config_file="$HOME/.config/work-lab/config"
if [[ -f "$config_file" ]]; then
  # shellcheck source=/dev/null
  source "$config_file"
fi

# Export for devcontainer.json ${localEnv:...} substitution
export WORK_LAB_IMAGE

# ─────────────────────────────────────────────────────────────────────────────
# Project detection
# ─────────────────────────────────────────────────────────────────────────────
# Find the git root of the current directory (or empty if not in a git repo)
find_git_root() {
  git rev-parse --show-toplevel 2>/dev/null
}

# Get the project name from the git root directory
get_project_name() {
  local git_root="$1"
  basename "$git_root"
}

# Build mount flags for devcontainer up
build_mount_flags() {
  local flags=()
  local mount_spec src_path tgt_path

  # Add read-only mounts (guard against empty array for Bash < 4.4)
  if (( ${#WORK_LAB_MOUNTS_RO[@]} > 0 )); then
    for mount_spec in "${WORK_LAB_MOUNTS_RO[@]}"; do
      # Validate format: must contain colon separator
      if [[ "$mount_spec" != *:* ]]; then
        echo "  [error] invalid mount spec (missing colon): $mount_spec" >&2
        continue
      fi
      src_path="${mount_spec%%:*}"
      tgt_path="${mount_spec#*:}"
      # Expand ~ and $HOME
      src_path="${src_path/#\~/$HOME}"
      src_path="${src_path//\$HOME/$HOME}"
      if [[ -e "$src_path" ]]; then
        flags+=("--mount" "type=bind,source=$src_path,target=$tgt_path,readonly")
        echo "  [ok] $src_path -> $tgt_path (ro)"
      else
        echo "  [warn] skipping (source not found): $src_path" >&2
      fi
    done
  fi

  # Add read-write mounts (guard against empty array for Bash < 4.4)
  if (( ${#WORK_LAB_MOUNTS_RW[@]} > 0 )); then
    for mount_spec in "${WORK_LAB_MOUNTS_RW[@]}"; do
      # Validate format: must contain colon separator
      if [[ "$mount_spec" != *:* ]]; then
        echo "  [error] invalid mount spec (missing colon): $mount_spec" >&2
        continue
      fi
      src_path="${mount_spec%%:*}"
      tgt_path="${mount_spec#*:}"
      # Expand ~ and $HOME
      src_path="${src_path/#\~/$HOME}"
      src_path="${src_path//\$HOME/$HOME}"
      if [[ -e "$src_path" ]]; then
        flags+=("--mount" "type=bind,source=$src_path,target=$tgt_path")
        echo "  [ok] $src_path -> $tgt_path (rw)"
      else
        echo "  [warn] skipping (source not found): $src_path" >&2
      fi
    done
  fi

  # Output flags (guard against empty array)
  if (( ${#flags[@]} > 0 )); then
    printf '%s\n' "${flags[@]}"
  fi
}

usage() {
  cat << EOF
work-lab - containerized environment for AI coding agents

Usage: work-lab <command>

Commands:
  up        Start work-lab for the current git project
  shell     Attach an interactive shell
  tmux      Attach to tmux session (creates 'lab' if missing)
  stop      Stop the container
  ps        List running work-lab containers
  doctor    Check environment and configuration
  version   Show version information
  help      Show this message

Run 'work-lab up' from any git repository to start.
Your project will be mounted at /workspaces/project inside the container.
EOF
}

cmd_version() {
  echo "work-lab $VERSION"
}

# Find the work-lab container (uses devcontainer's label)
find_container() {
  docker ps -q --filter "label=devcontainer.local_folder=$REPO_DIR" 2>/dev/null | head -n 1
}

# List all devcontainer instances (work-lab uses devcontainer under the hood)
cmd_ps() {
  echo "Running devcontainers:"
  echo ""
  docker ps --filter "label=devcontainer.local_folder" \
    --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Label \"devcontainer.local_folder\"}}" \
    2>/dev/null || echo "  (none)"
}

cmd_up() {
  if ! command -v devcontainer &> /dev/null; then
    echo "devcontainer CLI not found."
    echo "Install it with: npm install -g @devcontainers/cli"
    echo "Or open this folder in VS Code and use 'Reopen in Container'."
    exit 1
  fi

  # Detect project from current directory
  local project_root project_name
  project_root=$(find_git_root)
  if [[ -z "$project_root" ]]; then
    echo "Error: Not in a git repository." >&2
    echo "Run 'work-lab up' from the root of a git project." >&2
    exit 1
  fi
  project_name=$(get_project_name "$project_root")

  echo "Starting work-lab for: $project_name"
  echo "  Project: $project_root"

  # Build mount flags
  local mount_flags=()

  # Add project mount (the current git repo)
  mount_flags+=("--mount" "type=bind,source=$project_root,target=/workspaces/project")
  echo "  Mount: $project_root -> /workspaces/project"

  # Add additional mounts from config
  if (( ${#WORK_LAB_MOUNTS_RO[@]} > 0 )) || (( ${#WORK_LAB_MOUNTS_RW[@]} > 0 )); then
    echo "Additional mounts:"
    readarray -t -O "${#mount_flags[@]}" mount_flags < <(build_mount_flags)
  fi

  # Run devcontainer up
  devcontainer up --workspace-folder "$REPO_DIR" "${mount_flags[@]}"

  echo ""
  echo "Ready! Run 'work-lab shell' or 'work-lab tmux' to attach."
  echo "Project is at: /workspaces/project"
}

cmd_shell() {
  local container_id
  container_id=$(find_container)
  if [[ -z "$container_id" ]]; then
    echo "Container not running. Start it with: work-lab up" >&2
    exit 1
  fi
  docker exec -it -u vscode -w /workspaces/project "$container_id" bash
}

cmd_tmux() {
  local container_id
  container_id=$(find_container)
  if [[ -z "$container_id" ]]; then
    echo "Container not running. Start it with: work-lab up" >&2
    exit 1
  fi
  # Attach to existing session or create a new one named 'lab'
  docker exec -it -u vscode -w /workspaces/project "$container_id" \
    bash -c 'tmux attach -t lab 2>/dev/null || tmux new -s lab'
}

cmd_stop() {
  local container_id
  container_id=$(find_container)
  if [[ -z "$container_id" ]]; then
    echo "Container not running."
    exit 0
  fi
  echo "Stopping container..."
  docker stop "$container_id"
  echo "Stopped."
}

cmd_doctor() {
  local container_id config_dir project_count errors=0
  local mount_spec src_path tgt_path

  echo ""
  echo "work-lab doctor"
  echo "==============="
  echo ""

  # check work-lab repo
  echo "Repository:"
  if [[ -d "$REPO_DIR/.devcontainer" ]]; then
    echo "  [ok] $REPO_DIR"
  else
    echo "  [error] not found at $REPO_DIR"
    ((errors++))
  fi
  echo ""

  # check dependencies
  echo "Dependencies:"
  if command -v docker &>/dev/null; then
    echo "  [ok] docker: $(docker --version 2>/dev/null | head -n 1 || echo 'installed')"
    # Check if docker daemon is running
    if docker info &>/dev/null; then
      echo "  [ok] docker daemon: running"
    else
      echo "  [error] docker daemon: not running (start Docker Desktop or dockerd)"
      ((errors++))
    fi
  else
    echo "  [error] docker: not found (install from https://docs.docker.com/get-docker/)"
    ((errors++))
  fi
  if command -v devcontainer &>/dev/null; then
    echo "  [ok] devcontainer CLI: $(devcontainer --version 2>/dev/null || echo 'installed')"
  else
    echo "  [error] devcontainer CLI: not found"
    echo "         install with: npm install -g @devcontainers/cli"
    ((errors++))
  fi
  echo ""

  # check container status
  echo "Container:"
  if command -v docker &>/dev/null && docker info &>/dev/null; then
    container_id=$(find_container)
    if [[ -n "$container_id" ]]; then
      echo "  [ok] running (id: ${container_id:0:12})"
    else
      echo "  [info] not running (start with: work-lab up)"
    fi
  else
    echo "  [skip] cannot check (docker not available)"
  fi
  echo ""

  # show and validate configuration
  echo "Configuration:"
  config_dir="$HOME/.config/work-lab"
  if [[ -f "$config_dir/config" ]]; then
    echo "  [ok] config file: $config_dir/config"
  else
    echo "  [info] config file: not found (using defaults)"
  fi
  echo "  WORK_LAB_IMAGE=$WORK_LAB_IMAGE"
  echo ""

  # check current project (git repo)
  echo "Current project:"
  local git_root
  git_root=$(find_git_root)
  if [[ -n "$git_root" ]]; then
    echo "  [ok] $(get_project_name "$git_root")"
    echo "       $git_root"
  else
    echo "  [warn] not in a git repository"
    echo "         run 'work-lab up' from within a git project"
  fi
  echo ""

  # validate configured mounts
  echo "Configured mounts:"
  if (( ${#WORK_LAB_MOUNTS_RO[@]} == 0 && ${#WORK_LAB_MOUNTS_RW[@]} == 0 )); then
    echo "  [info] none configured (optional)"
  else
    # Check read-only mounts
    if (( ${#WORK_LAB_MOUNTS_RO[@]} > 0 )); then
      for mount_spec in "${WORK_LAB_MOUNTS_RO[@]}"; do
        if [[ "$mount_spec" != *:* ]]; then
          echo "  [error] invalid format (missing colon): $mount_spec"
          ((errors++))
          continue
        fi
        src_path="${mount_spec%%:*}"
        tgt_path="${mount_spec#*:}"
        # Expand ~ and $HOME
        src_path="${src_path/#\~/$HOME}"
        src_path="${src_path//\$HOME/$HOME}"
        if [[ -e "$src_path" ]]; then
          if [[ -r "$src_path" ]]; then
            echo "  [ok] $src_path -> $tgt_path (ro)"
          else
            echo "  [error] $src_path -> $tgt_path (ro) - not readable"
            ((errors++))
          fi
        else
          echo "  [warn] $src_path -> $tgt_path (ro) - source not found"
        fi
      done
    fi
    # Check read-write mounts
    if (( ${#WORK_LAB_MOUNTS_RW[@]} > 0 )); then
      for mount_spec in "${WORK_LAB_MOUNTS_RW[@]}"; do
        if [[ "$mount_spec" != *:* ]]; then
          echo "  [error] invalid format (missing colon): $mount_spec"
          ((errors++))
          continue
        fi
        src_path="${mount_spec%%:*}"
        tgt_path="${mount_spec#*:}"
        # Expand ~ and $HOME
        src_path="${src_path/#\~/$HOME}"
        src_path="${src_path//\$HOME/$HOME}"
        if [[ -e "$src_path" ]]; then
          if [[ -r "$src_path" && -w "$src_path" ]]; then
            echo "  [ok] $src_path -> $tgt_path (rw)"
          else
            echo "  [error] $src_path -> $tgt_path (rw) - not readable/writable"
            ((errors++))
          fi
        else
          echo "  [warn] $src_path -> $tgt_path (rw) - source not found"
        fi
      done
    fi
  fi
  echo ""

  # check user hooks
  echo "Lifecycle hooks:"
  if [[ -d "$config_dir" ]]; then
    if [[ -f "$config_dir/post-create.sh" ]]; then
      if [[ -x "$config_dir/post-create.sh" ]] || head -1 "$config_dir/post-create.sh" | grep -q '^#!'; then
        echo "  [ok] post-create.sh"
      else
        echo "  [warn] post-create.sh (missing shebang or not executable)"
      fi
    else
      echo "  [info] post-create.sh (not found)"
    fi
    if [[ -f "$config_dir/post-start.sh" ]]; then
      if [[ -x "$config_dir/post-start.sh" ]] || head -1 "$config_dir/post-start.sh" | grep -q '^#!'; then
        echo "  [ok] post-start.sh"
      else
        echo "  [warn] post-start.sh (missing shebang or not executable)"
      fi
    else
      echo "  [info] post-start.sh (not found)"
    fi
  else
    echo "  [info] ~/.config/work-lab/ not found (optional)"
  fi
  echo ""

  # mode detection
  echo "Mode:"
  if [[ -n "$git_root" ]]; then
    if [[ -d "$git_root/.devcontainer" ]] || [[ -f "$git_root/.devcontainer.json" ]]; then
      echo "  [info] Project has devcontainer -> Sidecar mode"
      echo "         work-lab runs alongside project's own devcontainer"
    else
      echo "  [info] Standalone mode"
      echo "         work-lab provides the development environment"
    fi
  fi
  echo ""

  # summary
  echo "─────────────────────────────"
  if (( errors > 0 )); then
    echo "Found $errors error(s). Fix them before running 'work-lab up'."
    return 1
  else
    echo "All checks passed. Ready to run 'work-lab up'."
    return 0
  fi
}

# Main
case "${1:-}" in
  up)
    cmd_up
    ;;
  shell)
    cmd_shell
    ;;
  tmux)
    cmd_tmux
    ;;
  stop)
    cmd_stop
    ;;
  ps)
    cmd_ps
    ;;
  doctor)
    cmd_doctor
    ;;
  version|--version|-v)
    cmd_version
    ;;
  help|--help|-h)
    usage
    ;;
  "")
    usage
    exit 1
    ;;
  *)
    echo "Unknown command: $1"
    usage
    exit 1
    ;;
esac
